<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Resale Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f7f9fb;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: all 0.15s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600 flex items-center">
                    <i data-lucide="scan-line" class="w-6 h-6 mr-2"></i>
                    Phoenix Resale
                </h1>
                <nav class="hidden md:flex space-x-4">
                    <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item text-gray-700 hover:text-blue-600 font-medium pb-1 border-b-2 border-transparent border-blue-600">Browse</button>
                    <button onclick="navigate('sell')" id="nav-sell" class="nav-item text-gray-700 hover:text-blue-600 font-medium pb-1 border-b-2 border-transparent">Sell Product</button>
                    <button onclick="navigate('my-listings')" id="nav-my-listings" class="nav-item text-gray-700 hover:text-blue-600 font-medium pb-1 border-b-2 border-transparent">My Listings</button>
                </nav>
                <div id="auth-status" class="text-xs text-gray-500 rounded-lg p-2 bg-gray-100 hidden md:block">
                    Loading Auth...
                </div>
            </div>

             <!-- Mobile Navigation -->
            <div class="md:hidden flex justify-around border-t border-gray-200 bg-white py-2">
                <button onclick="navigate('dashboard')" class="flex flex-col items-center nav-item text-blue-600">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Browse</span>
                </button>
                <button onclick="navigate('sell')" class="flex flex-col items-center nav-item text-gray-500 hover:text-blue-600">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Sell</span>
                </button>
                <button onclick="navigate('my-listings')" class="flex flex-col items-center nav-item text-gray-500 hover:text-blue-600">
                    <i data-lucide="list-checks" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">My Listings</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

            <!-- Loading/Error State -->
            <div id="loading" class="text-center p-12 text-gray-500">
                <i data-lucide="loader-circle" class="w-10 h-10 animate-spin mx-auto mb-4"></i>
                <p>Establishing connection and authenticating...</p>
            </div>
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <!-- Dashboard View (Browse Listings) -->
            <section id="dashboard" class="page-view hidden">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">All Resale Listings</h2>
                <div id="listings-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Products will be injected here -->
                    <p id="no-listings" class="col-span-full text-center text-gray-500 p-10 hidden">No products are currently listed for sale. Be the first to list one!</p>
                </div>
            </section>

            <!-- Sell Product View (Form) -->
            <section id="sell" class="page-view hidden">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">List a Product for Sale</h2>
                <form id="sell-form" class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto space-y-6">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="product-description" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price (USD)</label>
                            <input type="number" id="product-price" step="0.01" required min="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="product-image-url" class="block text-sm font-medium text-gray-700 mb-1">Image Placeholder Text</label>
                            <input type="text" id="product-image-url" placeholder="e.g., Blue Sneakers" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">This uses a placeholder service (placehold.co).</p>
                        </div>
                    </div>
                    <button type="submit" id="submit-btn" class="btn-primary w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                        List Product
                    </button>
                </form>
            </section>

            <!-- My Listings View -->
            <section id="my-listings" class="page-view hidden">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">My Current Listings</h2>
                <div id="my-listings-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User's products will be injected here -->
                    <p id="no-my-listings" class="col-span-full text-center text-gray-500 p-10 hidden">You haven't listed any products yet. Time to clear out some items!</p>
                </div>
            </section>

             <!-- Custom Modal for Confirmation/Contact -->
            <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300" onclick="closeModal(event)">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4" onclick="event.stopPropagation()">
                    <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                    <p id="modal-body" class="text-gray-600 mb-6"></p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button id="modal-confirm-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden">Delete</button>
                        <button id="modal-action-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 hidden">Contact Seller</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for better console feedback
        setLogLevel('Debug');

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let currentView = 'dashboard';

        // Global environment variables provided by the Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Utility function for retrying Firestore operations with exponential backoff.
         * @param {function} fn - The async function to execute.
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function withBackoff(fn, maxRetries = 3) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    console.error(Attempt ${i + 1} failed., error);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }


        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // 1. Initialize App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Initial Authentication Check
                const authStatusEl = document.getElementById('auth-status');
                const loadingEl = document.getElementById('loading');

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User is signed in (either via custom token or anonymously)
                            userId = user.uid;
                            authStatusEl.textContent = User ID: ${userId};
                            authStatusEl.classList.remove('text-gray-500', 'bg-gray-100');
                            authStatusEl.classList.add('text-green-600', 'bg-green-100');
                            console.log(Authenticated with userId: ${userId});
                            startDataListeners();
                            resolve();
                        } else {
                             // Attempt sign-in if token is available, otherwise sign in anonymously
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (e) {
                                console.error("Authentication failed, falling back to anonymous sign-in or failed:", e);
                                // If custom token fails, onAuthStateChanged should still trigger for anonymous or null user.
                                // If it still fails, the user will be null, and we let onAuthStateChanged handle the final state.
                            }
                        }
                        // Stop listening after the initial state is confirmed
                        unsubscribe();
                    });
                });

                // 3. Hide loading indicator and show the initial view
                loadingEl.classList.add('hidden');
                navigate(currentView);
            } catch (error) {
                console.error("Failed to initialize Firebase or authenticate:", error);
                document.getElementById('loading').classList.add('hidden');
                showError(Failed to load app. Check console for details. Error: ${error.message});
            }
        }

        /**
         * Generates the Firestore collection path for products.
         * Uses a private path based on the user ID.
         * @returns {string} The full Firestore path.
         */
        function getCollectionPath() {
            if (!userId) {
                throw new Error("User not authenticated for Firestore path.");
            }
            // Private path structure: /artifacts/{appId}/users/{userId}/resale_products
            return artifacts/${appId}/users/${userId}/resale_products;
        }

        /**
         * Starts the real-time listeners for product data.
         */
        function startDataListeners() {
            if (!userId || !db) {
                console.warn("Cannot start listeners: Firebase or User ID not ready.");
                return;
            }

            const productsRef = collection(db, getCollectionPath());
            console.log(Listening to path: ${getCollectionPath()});

            // Real-time listener for ALL products (Dashboard)
            onSnapshot(productsRef, (snapshot) => {
                const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts, 'listings-container', false);
                // Also update My Listings view
                const myProducts = allProducts.filter(p => p.sellerId === userId);
                renderProducts(myProducts, 'my-listings-container', true);
            }, (error) => {
                console.error("Error fetching all products:", error);
                showError("Could not load product listings in real-time.");
            });
        }

        /**
         * Renders the product cards into the specified container.
         * @param {Array} products - Array of product objects.
         * @param {string} containerId - ID of the HTML element to render into.
         * @param {boolean} isMyListings - Whether this is the current user's listing view.
         */
        function renderProducts(products, containerId, isMyListings) {
            const container = document.getElementById(containerId);
            const noListingsEl = document.getElementById(isMyListings ? 'no-my-listings' : 'no-listings');
            container.innerHTML = '';

            if (products.length === 0) {
                noListingsEl.classList.remove('hidden');
                return;
            }
            noListingsEl.classList.add('hidden');

            products.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); // Sort newest first

            products.forEach(product => {
                const isOwner = product.sellerId === userId;
                const price = typeof product.price === 'number' ? product.price.toFixed(2) : 'N/A';
                const imagePlaceholder = product.imageUrl || 'Product Placeholder';
                const placeholderUrl = https://placehold.co/400x300/a3e635/1c1917?text=${encodeURIComponent(imagePlaceholder)};

                const cardHtml = `
                    <div class="product-card bg-white rounded-xl overflow-hidden shadow-lg border border-gray-100 flex flex-col">
                        <!-- Image Area -->
                        <div class="h-48 bg-gray-100 overflow-hidden">
                             <img src="${placeholderUrl}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/60a5fa/ffffff?text=Image+Error';">
                        </div>

                        <!-- Content -->
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${product.name}</h3>
                            <p class="text-3xl font-extrabold text-blue-600 my-2">$${price}</p>
                            <p class="text-sm text-gray-500 mb-4 flex-grow line-clamp-3">${product.description}</p>
                            <div class="text-xs text-gray-400 mb-3">
                                <span class="font-medium">Seller:</span> ${isOwner ? 'You' : product.sellerId.substring(0, 8) + '...'}
                            </div>

                            <!-- Actions -->
                            <div class="mt-auto">
                                ${isMyListings ? `
                                    <button onclick="confirmDelete('${product.id}', '${product.name}')"
                                        class="w-full bg-red-100 text-red-600 p-2 rounded-lg font-semibold hover:bg-red-200 flex items-center justify-center">
                                        <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                                        Remove Listing
                                    </button>
                                ` : `
                                    <button onclick="contactSeller('${product.name}', '${product.sellerId}')"
                                        class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center">
                                        <i data-lucide="mail" class="w-4 h-4 mr-1"></i>
                                        Contact Seller
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
            // Re-render lucide icons after injecting HTML
            lucide.createIcons();
        }

        /**
         * Handles the submission of the sell form.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('sell-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.textContent = 'Listing...';
            submitBtn
